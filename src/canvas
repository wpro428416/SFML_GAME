#include "canvas.h"

Canvas::Canvas(sf::RenderWindow &window):window(window)
{
    launch = 0;
    for(int i=0;i<200;i++){
        tab[i]=0;
    }
}

Canvas::~Canvas(){}

void Canvas::append(sf::Vector2f x_y1,int mark){
    int i=0;
    int n=0;
    int range=60;
    int index_temp=index_bullet1;
    switch(mark){
        case 1:x_y1+=bullet1_adjust;i=0;n=0;range=60;index_temp=index_bullet1;break;
        case 2:x_y1+=bullet2_adjust;i=60;n=60;range=120;index_temp=index_bullet2;break;
        case 5:i=120;n=120;range=140;index_temp=index_enemy1;break;
        case 6:i=140;n=140;range=160;index_temp=index_enemy2;break;
        default:break;
    }
        store_x_y[index_temp]=x_y1;
        storeSprite[index_temp].setPosition(store_x_y[index_temp]);
        if(index_temp<range-1){
            switch (mark){
                case 1:index_bullet1++;break;
                case 2:index_bullet2++;break;
                case 5:index_enemy1++;break;
                case 6:index_enemy2++;break;
            }
        }
        else
        {
            switch (mark){
                case 1:
                    for(;i<range-1;){
                    if(store_x_y[i].y>0){
                        break;
                    }
                    i++;
                    }
                    break;
                case 2:
                case 5:
                case 6:
                    for(;i<range-1;){
                    if(store_x_y[i].y<600){
                        break;
                    }
                    i++;
                    }
                    break;
            }
            for(;i<range;i++,n++){
                store_x_y[n]=store_x_y[i];
            }
            switch (mark){
                case 1:index_bullet1=n;break;
                case 2:index_bullet2=n;break;
                case 5:index_enemy1=n;break;
                case 6:index_enemy2=n;break;
            }
        }
}

void Canvas::draw(){
    ////用来判断碰撞
         for(int i=0;i<index_bullet1;i++){
                for(int n=120;n<index_enemy1;n++){
                    if(check(storeSprite[n],storeSprite[i])){
                        if(tab[n]==0){
                            tab[n]++;
                            storeSprite[n].setTexture(enemy1_down1);
                        }
                        store_x_y[i].y=-20000;
                    }
                }

                for(int n=140;n<index_enemy2;n++){
                    if(check(storeSprite[n],storeSprite[i])){
                        if(tab[n]<2){
                            tab[n]++;
                            if(tab[n]==1){
                                storeSprite[n].setTexture(enemy2_hit);
                            }
                            else{
                                storeSprite[n].setTexture(enemy2_down1);
                            }
                        }
                        store_x_y[i].y=-20000;
                    }
                }
            }

            ////用来画小飞机、中等飞机、子弹
            for(int mark=1;mark<=10;mark++){
                int i=0;
                int index_temp=0;
                int adjust=0;
                int speed=0;
                if(mark>2&&mark<5){
                    continue;
                }
                switch(mark){
                    case 1:index_temp=index_bullet1;i=0;adjust=-20000;speed=-10;break;
                    case 2:index_temp=index_bullet2;i=60;adjust=20000;speed=5;break;
                    case 5:index_temp=index_enemy1;i=120;adjust=20000;speed=2;break;
                    case 6:index_temp=index_enemy2;i=140;adjust=20000;speed=1;break;
                    default:break;
                }

                for(;i<index_temp;i++){
                    switch (mark){
                        case 1:
                            if(store_x_y[i].y<0){
                                store_x_y[i].y=adjust;
                            }
                            break;
                        case 2:
                        case 5:
                        case 6:
                            if(store_x_y[i].y>700){
                                store_x_y[i].y=adjust;
                            }
                            break;
                        default:break;
                    }


                    if((tab[i]<1)||(tab[i]<2&&mark==6)){
                        storeSprite[i].setPosition(store_x_y[i]);
                        window.draw(storeSprite[i]);
                        store_x_y[i].y+=speed;
                        if(mark==5&&launch%200==10){//my be break wrong
                            Canvas::append(store_x_y[i],2);
                        }
                        if(mark==6&&launch%100==10){
                            sf::Vector2f temp = store_x_y[i];
                            temp.x+=6;
                            temp.y+=56;
                            Canvas::append(temp,2);
                            temp.x+=12;
                            Canvas::append(temp,2);
                            temp.x-=24;
                            Canvas::append(temp,2);
                        }
                    }
                    else if(mark==5){
                        tab[i]++;
                        window.draw(storeSprite[i]);
                        if(tab[i]==2){
                            storeSprite[i].setTexture(enemy1_down2);
                        }
                        if(tab[i]==3){
                            storeSprite[i].setTexture(enemy1_down3);
                        }
                        if(tab[i]==4){
                            storeSprite[i].setTexture(enemy1_down4);
                        }
                        if(tab[i]==5){
                            store_x_y[i].y=adjust;
                            storeSprite[i].setTexture(enemy1);
                            tab[i]=0;
                        }
                    }
                    else if(mark==6){
                        tab[i]++;
                        window.draw(storeSprite[i]);
                        if(tab[i]==3){
                            storeSprite[i].setTexture(enemy2_down2);
                        }
                        if(tab[i]==4){
                            storeSprite[i].setTexture(enemy2_down3);
                        }
                        if(tab[i]==5){
                            storeSprite[i].setTexture(enemy2_down4);
                        }
                        if(tab[i]==6){
                            store_x_y[i].y=adjust;
                            storeSprite[i].setTexture(enemy2);
                            tab[i]=0;
                        }
                    }
                }
            }
            launch++;
}


